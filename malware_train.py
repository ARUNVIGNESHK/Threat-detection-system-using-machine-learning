import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.preprocessing import StandardScaler
import pickle
import os

# ---------------- Ensure models directory exists ---------------- #
os.makedirs("models", exist_ok=True)

# ---------------- Load dataset ---------------- #
df = pd.read_csv("dataset_malwares.csv")

# ---------------- Detect target column ---------------- #
possible_labels = ["label", "malware", "class", "target", "Category"]
target_col = None
for col in df.columns:
    if col.strip().lower() in [p.lower() for p in possible_labels]:
        target_col = col
        break

if not target_col:
    raise ValueError(f"❌ No valid label column found. Available columns: {list(df.columns)}")

print(f"✅ Using target column: {target_col}")

# ---------------- Select numeric features ---------------- #
X = df.drop(columns=[target_col])
X = X.select_dtypes(include=["int64", "float64"])  # numeric only
y = df[target_col]

print(f"✅ Features selected: {list(X.columns)}")
print(f"✅ Total samples: {len(X)}")

# ---------------- Scale features ---------------- #
scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)

# ---------------- Train-test split ---------------- #
X_train, X_test, y_train, y_test = train_test_split(X_scaled, y, test_size=0.2, random_state=42)

# ---------------- Train model ---------------- #
clf = RandomForestClassifier(n_estimators=100, random_state=42)
clf.fit(X_train, y_train)

# ---------------- Save model, scaler, and features ---------------- #
with open("models/malware_model.pkl", "wb") as f:
    pickle.dump(clf, f)

with open("models/malware_scaler.pkl", "wb") as f:
    pickle.dump(scaler, f)

# Save feature list as pickle for Flask app
with open("models/malware_features.pkl", "wb") as f:
    pickle.dump(list(X.columns), f)

print("✅ Malware model, scaler, and feature list saved successfully!")